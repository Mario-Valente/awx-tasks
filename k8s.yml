- name: Run command in pods 
  hosts: all
  tasks: 
    
   
    - name: Obter credenciais do cluster EKS
      aws_eks:
        name: "{{ CLUSTER_NAME }}"
        region: us-east-1
      register: eks_result

    - name: Salvar credenciais no arquivo kubeconfig
      copy:
        content: "{{ eks_result.kubeconfig_content }}"
        dest: /root/.kube/config  # Substitua pelo caminho correto do kubeconfig
        mode: '0600'
      when: eks_result.changed
   
   
    - name: Obter as credenciais do cluster EKS
      command: "{{ kubectl_path }} eks get-token --cluster-name $CLUSTER_NAME"
      register: kubeconfig_token
    
    - name: Obter o nome do pod dinamicamente
      k8s_facts:
        kubeconfig: /root/.kube/config 
        namespace: "{{ namespace }}"
        label_selectors:
          - "service-geolocation-api"
      register: pod_info
    
    - name: Verificar se o pod foi encontrado
      fail:
        msg: "Nenhum pod foi encontrado com o seletor 'service-geolocation-api' no namespace '{{ namespace }}'"
      when: pod_info.resources | length == 0

    - name: Extrair o nome do pod
      :
        pod_name: "{{ pod_info.resources[0].metadata.name }}"

    - name: Executar comando no pod
      k8s:
        kubeconfig: /root/.kube/config # Substitua pelo caminho correto
        namespace: "{{ namespace }}"
        pod: "{{ pod_name }}"
        command: "/bin/bash -c  {{COMAND}}"set_fact